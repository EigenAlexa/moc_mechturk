<template name="experiment">
    <div class="col-md-12">
        <h1>Wagering Game</h1>
    </div>

    <div class="col-md-12">
        {{> gameInstructions}}
    </div>

    {{! Table of users next to number line}}
    <div class="col-md-4 coin-flips">
        {{> coinTable}}
    </div>

    <div class="col-md-8 flip-guesser">
        {{#if guessesReady}}
        {{> controller}}
        {{/if}}
    </div>

    <div class="col-md-12">
    {{> testForm}}
    </div>

    {{#if tutorialEnabled}}
    {{> tutorial tutorialOptions}}
    {{/if}}
</template>

<template name="coinTable">
    {{! Lay out all users in a simple table }}

    <table class="table table-striped">
        <thead>
        <tr>
            <th>{{! User}}</th>
            <th>{{! Info }}</th>
            <th>Guess</th>
        </tr>
        </thead>
        <tbody>
        {{#each opponents}}
            <tr>
                <td>
                    <img src='img/ppl-{{imageHash}}.jpg' height="20"> {{oppName}}
                </td>
                <td>(saw {{numPrivate}} flips)</td>
                {{#if oppoGuessed}}
                    <td class="success">Submitted!</td>
                {{else}}
                    <td class="warning">Waiting...</td>
                {{/if}}
            </tr>
        {{/each}}
        </tbody>
    </table>

    {{> infoDisplay }}
</template>

<template name="infoDisplay">
    <h3><b>What everyone saw:</b></h3>
    <h3 class="text-center">{{> displayFlips publicFlips}}</h3>

    <h3><b>What only you saw:</b></h3>
    <h3 class="text-center">{{> displayFlips privateFlips}}</h3>
</template>

<template name="displayFlips">
    {{#each this}}
        {{#if this}}
        <img src='img/coin-head.png' height="20">
        {{else}}
        <img src='img/coin-tail.jpg' height="20">
        {{/if}}
    {{/each}}
    ({{heads}} heads / {{total}} flips)
</template>

<template name="controller">
    {{#if delphiPhase}}
        {{#if myGuess.delphi }}
            <h3>
                <span class="text-warning">Waiting for others to submit their
                initial guesses.</span>
            </h3>
        {{else}}
            <h3 class="text-danger">
                Enter an initial guess. You will then see what others think.
            </h3>
        {{/if}}

        {{> numberLine existing="delphi" }}
    {{/if}}

    {{#if finalPhase}}
        {{#if delphiGame}}
            <h3>Here's what everyone thinks so far.</h3>
            {{> numberLine field="delphi" }}

            {{#if myGuess.answer}}
            <h3 class="text-warning">Waiting for everyone else to guess again.</h3>
            {{else}}
            <h3>You can now change your guess.</h3>
            {{/if}}

            {{> numberLine existing="delphi" }}
        {{else}}
            {{#if myGuess.answer}}
            <h3 class="text-warning">
                <span class="text-warning">
                    Waiting for everyone else to guess.</span>
            </h3>
            {{else}}
            <h3>Enter your guess of the number of heads of 100 coin flips.</h3>
            {{/if}}
            {{> numberLine existing="answer" }}
        {{/if}}
    {{/if}}

    {{#if completedPhase}}
        {{#if delphiGame}}
            <h3>Preliminary results:</h3>
            {{> numberLine field="delphi" }}
        {{/if}}

        <h3>The final results:</h3>
        {{> numberLine field="answer" }}
        {{> gameResults }}
    {{/if}}
</template>

<!-- Shows everyone's guesses in the delphi or result.
    To make this easier to display, layout doesn't need to be reactive.
-->
<template name="numberLine">
    <svg class="center-block" width="{{c 'width'}}" height="{{c 'height'}}">
        {{! arrowhead - http://vanseodesign.com/web-design/svg-markers/ }}
        <defs>
            <marker id="arrow" markerWidth="10" markerHeight="10" refx="8" refy="3" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L0,6 L9,3 z" fill="#000" />
            </marker>
        </defs>

        {{! number line layout }}
        <g class="line-group" transform="translate({{middle}},{{c 'lineY'}})">
            <line class="number-line" x1="{{c 'left'}}" x2="{{c 'right'}}"
                  y1="0" y2="0"></line>
            <text text-anchor="end" x="{{c 'left'}}" y="0">
                0 of 100 &nbsp;</text>
            <text text-anchor="start" x="{{c 'right'}}" y="0">
                &nbsp; 100 of 100</text>

            {{#unless field}}
            {{! unless in feedback mode, don't show drag handle }}
            <g class="handle draggable">
                <circle class="draggable" cx="0" r="11"></circle>
                <text class="me" text-anchor="middle" font-size="20"
                      y="-20"></text>
            </g>
            {{/unless}}

            {{! guess values drawn here }}
        </g>
        {{! result and payoff layout }}
        <g class="node-group" transform="translate({{middle}},{{c 'nodeY'}})">
            {{! text and lines are drawn here }}
        </g>
    </svg>

    {{#unless guessSubmitted}}
    {{#with guessValue}}
        <h3>You guess that there will be {{this}} heads in 100 flips.
            <button class="btn btn-primary btn-lg center-block confirm-guess">
                Confirm</button>
        </h3>
    {{/with}}
    {{/unless}}
</template>

<!-- Template showing results of a game -->
<template name="gameResults">
    {{! Show ground truth }}
    <h3 class="text-center">
        On average, this coin comes up heads
        <b class="text-success">{{prob}}</b> times in 100 flips.</h3>

    {{! Show guess }}
    <h3 class="text-center">
        {{#if isCollInc}}
            Your group guessed an average of
            <b class="text-warning">{{ avgGuess }}</b>.
        {{else}}
            You guessed <b class="text-info">{{ myAnswer }}</b>.
        {{/if}}
    </h3>

    {{! Explain payoff }}
    <h3 class="text-center">
      {{# if isCompInc}}
        {{# if myWinStatus }}
          {{! TODO better message for ties }}
            You are one of the closest players to the actual value.
            You earned a bonus of <b>{{ myPayoff }}</b>.
        {{else}}
          You did not earn anything since you did not have the closest guess.
        {{/if}}
      {{else}}
          {{#if isCollInc}}
              You and everyone in your group earned a bonus of
              <b>{{ myPayoff }}</b>.
          {{else}}
              You earned a bonus of <b>{{ myPayoff }}</b>.
          {{/if}}
      {{/if}}
    </h3>
</template>
