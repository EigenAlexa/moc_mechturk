<template name="experiment">
    <div class="col-md-12">
        {{> gameInstructions}}
    </div>

    {{! Table of users next to number line}}
    <div class="col-md-4">
        {{> coinTable}}
    </div>

    <div class="col-md-8">
        {{#if guessesReady}}
        {{> controller}}
        {{/if}}
    </div>

    <div class="col-md-12">
    {{> testForm}}
    </div>
</template>

<template name="coinTable">
    {{! Lay out all users in a simple table }}

    <table class="table table-striped">
        <thead>
        <tr>
            <th>{{! User}}</th>
            <th>{{! Info }}</th>
            <th>Guess</th>
        </tr>
        </thead>
        <tbody>
        {{#each opponents}}
            <tr>
                <td>
                    <img src='img/ppl-{{imageHash}}.jpg' height="20"> {{oppName}}
                </td>
                <td>(saw {{numPrivate}} flips)</td>
                {{#if oppoGuessed}}
                    <td class="success">Submitted!</td>
                {{else}}
                    <td class="warning">Waiting...</td>
                {{/if}}
            </tr>
        {{/each}}
        </tbody>
    </table>

    {{> infoDisplay }}
</template>

<template name="infoDisplay">
    <h3><b>What everyone saw:</b></h3>
    <h3 class="text-center">{{> displayFlips publicFlips}}</h3>

    <h3><b>What only you saw:</b></h3>
    <h3 class="text-center">{{> displayFlips privateFlips}}</h3>
</template>

<template name="displayFlips">
    {{#each this}}
        {{#if this}}
        <img src='img/coin-head.png' height="20">
        {{else}}
        <img src='img/coin-tail.jpg' height="20">
        {{/if}}
    {{/each}}
    ({{heads}} heads / {{total}} flips)
</template>

<template name="controller">
    {{> prompt }}

    {{#if delphiPhase}}
    {{> numberLine "delphi" }}
    (Test)
    {{/if}}

    {{#if finalPhase}}
    {{> numberLine}}
    (Test)
    {{/if}}

    {{#if completedPhase}}
    {{> numberLine}}
    {{> gameResults }}
    {{/if}}
</template>

<template name="prompt">
    {{#if delphiPhase}}
        {{#if myGuess.delphi }}
            <h3 class="text-warning">Waiting for others to submit their
                initial guesses.</h3>
        {{else}}
            <h3 class="text-danger">Enter an initial guess. You will have a chance to change your guess afterward.</h3>
        {{/if}}
    {{else}}
        {{#if myGuess.answer}}
            {{#if completedPhase}}
                <h3>Here are the results:</h3>
            {{else}}
                <h3 class="text-warning">Waiting for everyone else to guess.</h3>
            {{/if}}
        {{else}}
            {{#if delphiGame}}
                <h3>Here's what everyone thinks so far. You can now change your
                    guess.</h3>
            {{else}}
                <h3>Enter your guess.</h3>
            {{/if}}
        {{/if}}
    {{/if}}
</template>

<!-- Shows everyone's guesses in the delphi or result.
    To make this easier to display, layout doesn't need to be reactive.
-->
<template name="numberLine">
    <svg class="center-block" width="{{c 'width'}}" height="{{c 'height'}}">
        {{! arrowhead - http://vanseodesign.com/web-design/svg-markers/ }}
        <defs>
            <marker id="arrow" markerWidth="10" markerHeight="10" refx="8" refy="3" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L0,6 L9,3 z" fill="#000" />
            </marker>
        </defs>

        {{! number line layout }}
        <g class="line-group" transform="translate({{middle}},{{c 'lineY'}})">
            <line class="number-line" x1="{{c 'left'}}" x2="{{c 'right'}}"
                  y1="0" y2="0"></line>
            {{! guess values drawn here }}
            {{#unless completedPhase}}
            <g class="handle draggable">
                <circle class="draggable" cx="0" r="8"></circle>
                <text class="me" text-anchor="middle" font-size="20"
                      y="-20"></text>
            </g>
            {{/unless}}
        </g>
        {{! result and payoff layout }}
        <g class="node-group" transform="translate({{middle}},{{c 'nodeY'}})">
            {{! text and lines are drawn here }}
        </g>
    </svg>

    {{#with guessValue}}
        <button class="btn btn-primary btn-lg center-block confirm-guess">
            Confirm your guess of {{this}}</button>
    {{/with}}

</template>

<!-- Template showing results of a game -->
<template name="gameResults">
    {{! Show ground truth }}
    <h3 class="text-center">
        On average, this coin comes up heads
        <b class="text-success">{{prob}}</b> times in 100 flips.</h3>

    {{! Show guess }}
    <h3 class="text-center">
        {{#if isCollInc}}
            Your group guessed an average of
            <b class="text-warning">{{ avgGuess }}</b>.
        {{else}}
            You guessed <b class="text-info">{{ myAnswer }}</b>.
        {{/if}}
    </h3>

    {{! Explain payoff }}
    <h3 class="text-center">
      {{# if isCompInc}}
        {{# if myWinStatus }}
          {{! TODO better message for ties }}
            You are one of the closest players to the actual value.
            You earned a bonus of <b>{{ myPayoff }}</b>.
        {{else}}
          You did not earn anything since you did not have the closest guess.
        {{/if}}
      {{else}}
          {{#if isCollInc}}
              You and everyone in your group earned a bonus of
              <b>{{ myPayoff }}</b>.
          {{else}}
              You earned a bonus of <b>{{ myPayoff }}</b>.
          {{/if}}
      {{/if}}
    </h3>
</template>
